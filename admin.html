<!doctype html>
<html lang="en-ZA">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Track Ticket | AlphaWave Solutions</title>
  <meta name="description" content="Track your AlphaWave ticket using your Ticket ID." />
  <link rel="icon" href="assets/favicon.svg" type="image/svg+xml" />
  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="stylesheet" href="assets/styles.css" />
</head>

<body>
<header>
  <div class="container">
    <nav class="nav">
      <a class="brand" href="index.html">
        <img src="assets/favicon.svg" alt="AlphaWave logo" />
        <div class="title">
          <b>AlphaWave Solutions</b>
          <span>Elim ‚Ä¢ Western Cape</span>
        </div>
      </a>

      <div class="menu" aria-label="Primary navigation">
        <a data-nav href="index.html">Home</a>
        <a data-nav href="services.html">Services</a>
        <a data-nav href="pricing.html">Pricing</a>
        <a data-nav href="admin.html">Track Ticket</a>
        <a data-nav href="privacy.html">Privacy</a>
      </div>

      <div class="nav-actions">
        <button class="mobile-toggle" data-menu-btn aria-label="Open menu">Menu</button>
        <a class="btn primary" href="quote.html">Request a Quote ‚Üí</a>
      </div>
    </nav>

    <div class="mobile-menu" data-mobile-menu>
      <a data-nav href="index.html">Home</a>
      <a data-nav href="services.html">Services</a>
      <a data-nav href="pricing.html">Pricing</a>
      <a data-nav href="admin.html">Track Ticket</a>
      <a data-nav href="privacy.html">Privacy</a>
      <a class="btn primary wide" href="quote.html">Request a Quote ‚Üí</a>
    </div>
  </div>
</header>

<main class="section">
  <div class="container">
    <h2>Track Ticket</h2>
    <p class="sub" style="text-align:center; margin: 0 auto 18px;">
      Enter your Ticket ID (example: <b>Q-AB12CD34</b>) to view progress.
    </p>

    <div class="panel form">
      <div class="grid-2">
        <div>
          <label>Ticket ID</label>
          <input id="ticketId" placeholder="e.g. Q-AB12CD34" autocomplete="off" />
        </div>
        <div>
          <label>Actions</label>
          <div class="actions" style="margin-top:0;">
            <button class="btn primary" type="button" id="btnTrack">Track</button>
            <button class="btn" type="button" id="btnClear">Clear</button>
          </div>
        </div>
      </div>

      <div id="resultWrap" style="margin-top:14px; display:none;">
        <div class="card" style="min-height:auto;">
          <div class="top" style="margin-bottom:6px;">
            <div class="ico">üßæ</div>
            <h3 style="margin:0;">Ticket Details</h3>
          </div>

          <div class="note" id="statusLine" style="margin:10px 0 12px;"></div>

          <div class="cards" style="grid-template-columns: 1fr 1fr; gap:12px;">
            <div class="card" style="min-height:auto; box-shadow:none;">
              <p class="note" style="margin:0;"><b>Ticket ID:</b> <span id="outId"></span></p>
              <p class="note" style="margin:8px 0 0;"><b>Submitted:</b> <span id="outSubmitted"></span></p>
              <p class="note" style="margin:8px 0 0;"><b>Last Updated:</b> <span id="outUpdated"></span></p>
              <p class="note" style="margin:8px 0 0;"><b>Status:</b> <span id="outStatus"></span></p>
            </div>

            <div class="card" style="min-height:auto; box-shadow:none;">
              <p class="note" style="margin:0;"><b>Name:</b> <span id="outName"></span></p>
              <p class="note" style="margin:8px 0 0;"><b>Phone:</b> <span id="outPhone"></span></p>
              <p class="note" style="margin:8px 0 0;"><b>Service:</b> <span id="outService"></span></p>
              <p class="note" style="margin:8px 0 0;"><b>Device:</b> <span id="outDevice"></span></p>
              <p class="note" style="margin:8px 0 0;"><b>Preferred:</b> <span id="outPref"></span></p>
            </div>
          </div>

          <p class="note" style="margin-top:12px;"><b>Issue:</b></p>
          <div class="note" id="outIssue" style="white-space:pre-wrap; margin-top:6px;"></div>

          <div class="actions" style="margin-top:14px;">
            <a class="btn" id="btnWA" target="_blank" rel="noopener">WhatsApp Support</a>
            <a class="btn ghost" href="quote.html">Request Another Quote</a>
          </div>

          <p class="note" id="sourceHint" style="margin-top:12px;"></p>
        </div>
      </div>

      <p class="note" style="margin-top:14px;">
        If you can‚Äôt find your ticket, please WhatsApp us your Ticket ID and details.
      </p>
    </div>
  </div>
</main>

<footer>
  <div class="container foot">
    <div>¬© <span data-year></span> AlphaWave Solutions ‚Ä¢ Elim ‚Ä¢ Western Cape</div>
    <div style="display:flex; gap:12px; flex-wrap:wrap;">
      <a href="services.html">Services</a>
      <a href="pricing.html">Pricing</a>
      <a href="admin.html">Track Ticket</a>
      <a href="privacy.html">Privacy</a>
    </div>
  </div>
</footer>

<script src="assets/config.js"></script>
<script src="assets/main.js"></script>

<script>
(() => {
  const WA_NUMBER = "27615224124";
  const LOCAL_KEY = "alphawave_quotes";

  const $ = (id) => document.getElementById(id);
  const ticketInput = $("ticketId");
  const wrap = $("resultWrap");
  const sourceHint = $("sourceHint");

  function norm(v){ return String(v || "").trim().toUpperCase(); }

  function fmt(iso) {
    if (!iso) return "-";
    try {
      const d = new Date(iso);
      return d.toLocaleString("en-ZA", { year:"numeric", month:"short", day:"2-digit", hour:"2-digit", minute:"2-digit" });
    } catch {
      return iso;
    }
  }

  function setText(id, v){ $(id).textContent = v || "-"; }

  function showRecord(rec, sourceLabel) {
    wrap.style.display = "block";

    // Support BOTH formats:
    // - our website format: {id, createdAt, name, phone, service, device, pref, issue, status}
    // - Apps Script title-case mapped format: {ticketId, submittedAt, customerName, ...}
    const ticketId = rec.ticketId || rec.id;
    const submittedAt = rec.submittedAt || rec.createdAt;
    const updatedAt = rec.lastUpdatedAt || rec.lastUpdatedAt || rec.updatedAt || "";

    const name = rec.customerName || rec.name;
    const phone = rec.phoneNumber || rec.phone;
    const service = rec.serviceRequested || rec.service;
    const device = rec.deviceDetails || rec.device;
    const pref = rec.preferredContact || rec.pref;
    const issue = rec.issueDescription || rec.issue;

    const status = rec.status || "Received";

    setText("outId", ticketId);
    setText("outSubmitted", fmt(submittedAt));
    setText("outUpdated", fmt(updatedAt));
    setText("outStatus", status);

    setText("outName", name);
    setText("outPhone", phone);
    setText("outService", service);
    setText("outDevice", device);
    setText("outPref", pref);
    $("outIssue").textContent = issue || "-";

    $("statusLine").innerHTML = `Status: <b>${status}</b> ‚úÖ`;

    const waMsg =
`Hi AlphaWave Solutions,
I want an update on my ticket.

Ticket ID: ${ticketId}
Name: ${name || "-"}
Phone: ${phone || "-"}`;

    $("btnWA").href = `https://wa.me/${WA_NUMBER}?text=${encodeURIComponent(waMsg)}`;

    sourceHint.textContent = sourceLabel;
  }

  function showNotFound(id) {
    wrap.style.display = "block";
    $("statusLine").innerHTML =
      `Status: <b>Not Found</b> ‚ö†Ô∏è<br/>Please WhatsApp us your Ticket ID and details.`;

    setText("outId", id || "-");
    setText("outSubmitted", "-");
    setText("outUpdated", "-");
    setText("outStatus", "-");
    setText("outName", "-");
    setText("outPhone", "-");
    setText("outService", "-");
    setText("outDevice", "-");
    setText("outPref", "-");
    $("outIssue").textContent = "-";

    const waMsg =
`Hi AlphaWave Solutions,
My ticket is not showing.

Ticket ID: ${id || "-"}
My name:
My phone:
Service:
Device:
Problem:`;

    $("btnWA").href = `https://wa.me/${WA_NUMBER}?text=${encodeURIComponent(waMsg)}`;
    sourceHint.textContent = "";
  }

  function findLocal(id) {
    try {
      const list = JSON.parse(localStorage.getItem(LOCAL_KEY) || "[]");
      return list.find(r => norm(r.id) === id) || null;
    } catch {
      return null;
    }
  }

  async function fetchRemote(id) {
    const url = window.ALPHAWAVE && window.ALPHAWAVE.TICKETS_API_URL;
    if (!url) throw new Error("Missing TICKETS_API_URL in assets/config.js");

    const u = `${url}?ticketId=${encodeURIComponent(id)}`;
    const res = await fetch(u, { method: "GET" });
    const data = await res.json();
    if (!data || data.ok !== true) throw new Error((data && data.error) ? data.error : "Remote not found");
    return data.record;
  }

  async function track() {
    const id = norm(ticketInput.value);
    if (!id) { ticketInput.focus(); return; }

    // 1) Try remote (global)
    try {
      const rec = await fetchRemote(id);
      showRecord(rec, "Source: Global tracking (Google Sheets) ‚úÖ");
      return;
    } catch (e) {
      // 2) fallback local
      const local = findLocal(id);
      if (local) {
        showRecord(local, "Source: This device only (local save) ‚úÖ");
        return;
      }
      showNotFound(id);
    }
  }

  $("btnTrack").addEventListener("click", track);
  ticketInput.addEventListener("keydown", (e) => { if (e.key === "Enter") track(); });
  $("btnClear").addEventListener("click", () => {
    ticketInput.value = "";
    wrap.style.display = "none";
    ticketInput.focus();
  });

  // Auto-track if URL has ?id=...
  const params = new URLSearchParams(location.search);
  const qid = norm(params.get("ticketId") || params.get("id"));
  if (qid) {
    ticketInput.value = qid;
    track();
  }
})();
</script>

</body>
</html>

